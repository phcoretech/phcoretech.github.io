<style>
    /* Animación de entrada */
    .module-container { 
        max-width: 1100px; 
        margin: 0 auto; 
        padding-bottom: 80px; 
        animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Tarjetas Corporativas */
    .card-panel { 
        background: #FFFFFF; 
        border-radius: 12px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        padding: 30px; 
        margin-bottom: 20px;
        border: 1px solid #E2E8F0;
    }

    /* Encabezados */
    .section-header { 
        display: flex; align-items: center; gap: 12px; 
        padding-bottom: 15px; margin-bottom: 25px; 
        border-bottom: 2px solid #F1F5F9; color: var(--inb-navy);
    }
    .section-header i { font-size: 1.4rem; color: var(--inb-red); }
    .section-header h3 { font-size: 1.1rem; font-weight: 700; margin: 0; }

    /* Grillas */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; }
    @media (max-width: 900px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; gap: 15px; } }

    /* Inputs y Labels */
    label { 
        display: block; font-size: 0.75rem; color: #64748B; 
        font-weight: 700; margin-bottom: 6px; text-transform: uppercase; 
    }
    
    input, select, textarea { 
        width: 100%; padding: 12px; background: #F8FAFC; 
        border: 1px solid #E2E8F0; border-radius: 6px; 
        color: #334155; font-family: 'Inter', sans-serif; font-size: 0.95rem;
        transition: all 0.2s;
    }
    
    input:focus, select:focus, textarea:focus { 
        border-color: var(--inb-blue-soft); background: #fff; 
        box-shadow: 0 0 0 3px rgba(0, 93, 170, 0.1); 
    }
    
    input:read-only { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: transparent;}
    .req { color: var(--inb-red); margin-left: 3px; }

    /* Badge de Modo */
    .mode-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; display: inline-block; }
    .mode-new { background: #DBEAFE; color: #1E40AF; } 
    .mode-edit { background: #DCFCE7; color: #166534; } 

    /* Botones */
    .btn-save { 
        background: var(--inb-navy); color: white; font-weight: 600; border: none; 
        padding: 15px; border-radius: 8px; font-size: 1rem; 
        display: flex; align-items: center; justify-content: center; gap: 10px;
        transition: background 0.2s; cursor: pointer;
    }
    .btn-save:hover { background: #002244; }

    .btn-refresh {
        background: #F1F5F9; border: 1px solid #E2E8F0; color: var(--inb-navy);
        padding: 0 15px; border-radius: 6px; cursor: pointer; font-size: 1.2rem;
        display: flex; align-items: center; justify-content: center;
    }
    .btn-refresh:hover { background: #e2e8f0; color: var(--inb-blue-soft); }

</style>

<div class="module-container">

    <div class="card-panel" style="border-top: 4px solid var(--inb-blue-soft);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: var(--inb-navy); font-weight: 700;">Gestión de Entrevistas</h3>
            <span id="modeBadge" class="mode-badge mode-new">Nuevo Registro</span>
        </div>
        
        <label>Seleccionar Candidato de la Lista</label>
        <div style="display: flex; gap: 10px;">
            <select id="candidateSelect" onchange="seleccionarCandidato(this.value)" style="cursor: pointer;">
                <option value="new">-- REGISTRAR NUEVO CANDIDATO (Formulario en Blanco) --</option>
                <option disabled>Cargando lista...</option>
            </select>
            
            <button class="btn-refresh" onclick="cargarListaCandidatos()" title="Actualizar lista">
                <i class="ph-bold ph-arrows-clockwise"></i>
            </button>
        </div>
        <small style="color: #94a3b8; margin-top: 5px; display: block;">
            * Si el candidato ya se postuló, búscalo en la lista para cargar sus datos.
        </small>
    </div>

    <form id="formEntrevista" onsubmit="guardarDatos(event)">
        
        <div class="card-panel">
            <div class="section-header">
                <i class="ph-duotone ph-identification-card"></i>
                <h3>Información Personal</h3>
            </div>
            
            <div class="grid-2">
                <div>
                    <label>Nombre Completo <span class="req">*</span></label>
                    <input type="text" id="full_name" required style="text-transform: uppercase;">
                </div>
                <div>
                    <label>CURP <span class="req">*</span></label>
                    <input type="text" id="curp" maxlength="18" required style="text-transform: uppercase;" oninput="procesarCurp(this.value)">
                    <small id="curp-feedback" style="font-size: 0.75rem; min-height: 1.2em; display:block;"></small>
                </div>
            </div>

            <div class="grid-4">
                <div>
                    <label>Fecha Nacimiento</label>
                    <input type="date" id="birth_date" readonly tabindex="-1">
                </div>
                <div>
                    <label>Edad</label>
                    <input type="number" id="age" readonly tabindex="-1">
                </div>
                <div>
                    <label>Edad Emocional <span class="req">*</span></label>
                    <input type="number" id="edad_emocional" required min="15" max="99" placeholder="Calculada">
                </div>
                <div>
                    <label>Estado Civil <span class="req">*</span></label>
                    <select id="marital_status" required>
                        <option value="">SELECCIONAR...</option>
                        <option value="SOLTERO">SOLTERO</option>
                        <option value="CASADO">CASADO</option>
                        <option value="UNION LIBRE">UNION LIBRE</option>
                        <option value="DIVORCIADO">DIVORCIADO</option>
                    </select>
                </div>
            </div>

            <div class="grid-2" style="margin-top: 20px;">
                <div>
                    <label>Teléfono <span class="req">*</span></label>
                    <input type="tel" id="phone" required pattern="[0-9]{10}" maxlength="10">
                </div>
                <div>
                    <label>Correo Electrónico <span class="req">*</span></label>
                    <input type="email" id="email" required>
                </div>
            </div>
        </div>

        <div class="card-panel">
            <div class="section-header">
                <i class="ph-duotone ph-users-three"></i>
                <h3>Perfil Socioeconómico</h3>
            </div>
            
            <div class="grid-4">
                <div>
                    <label>¿Tiene Hijos?</label>
                    <select id="tiene_hijos" onchange="toggleHijos()">
                        <option value="false">NO</option>
                        <option value="true">SI</option>
                    </select>
                </div>
                <div>
                    <label>Cantidad Hijos</label>
                    <input type="number" id="cantidad_hijos" value="0" readonly min="0">
                </div>
                <div>
                    <label>Crédito Infonavit</label>
                    <select id="credito_infonavit" onchange="checkInfonavit()">
                        <option value="false">NO</option>
                        <option value="true">SI</option>
                    </select>
                </div>
                <div>
                    <label>Perfil Asignado</label>
                    <select id="perfil">
                        <option value="PROVISIONAL" selected>PROVISIONAL</option>
                        <option value="DEFINITIVA">DEFINITIVA</option>
                        <option value="WALMART">WALMART</option>
                    </select>
                </div>
            </div>
            
            <div class="grid-3" style="margin-top: 20px;">
                <div>
                    <label>Clave Asesor</label>
                    <input type="text" id="clave_asesor" value="000" placeholder="000">
                </div>
                <div>
                    <label>Plaza (Estado) <span class="req">*</span></label>
                    <select id="plaza" required>
                        <option value="">SELECCIONAR...</option>
                    </select>
                </div>
                <div>
                    <label>Veritas / Gerencia</label>
                    <input type="text" id="veritas_gerencia" placeholder="Opcional">
                </div>
            </div>
        </div>

        <div class="card-panel">
            <div class="section-header">
                <i class="ph-duotone ph-chat-centered-text"></i>
                <h3>Datos de Entrevista</h3>
            </div>

            <div class="grid-3">
                <div>
                    <label>Nivel de Estudios <span class="req">*</span></label>
                    <select id="education" required>
                        <option value="">SELECCIONAR...</option>
                        <option value="SECUNDARIA">SECUNDARIA</option>
                        <option value="PREPARATORIA">PREPARATORIA</option>
                        <option value="LICENCIATURA">LICENCIATURA</option>
                        <option value="LICENCIATURA TRUNCA">LICENCIATURA TRUNCA</option>
                        <option value="LICENCIATURA EN PROCESO">LICENCIATURA EN PROCESO</option>
                        <option value="MAESTRIA">MAESTRIA</option>
                        <option value="DOCTORADO">DOCTORADO</option>
                    </select>
                </div>
                <div>
                    <label>Fecha Examen</label>
                    <input type="date" id="fecha_examen">
                </div>
                <div>
                    <label>Medio Reclutamiento</label>
                    <select id="medio_reclutamiento">
                        <option value="">SELECCIONAR...</option>
                        <option value="OCC">OCC</option>
                        <option value="REDES SOCIALES">REDES SOCIALES</option>
                        <option value="REFERIDO">REFERIDO</option>
                        <option value="FERIA EMPLEO">FERIA EMPLEO</option>
                    </select>
                </div>
            </div>

            <div class="grid-2" style="margin-top: 20px;">
                <div>
                    <label>Perfil Familiar</label>
                    <textarea id="perfil_familiar" rows="3" placeholder="Descripción breve del entorno familiar..."></textarea>
                </div>
                <div>
                    <label>Sueño por Realizar</label>
                    <textarea id="sueno_realizar" rows="3" placeholder="Metas personales o profesionales..."></textarea>
                </div>
                <div>
                    <label>Área de Oportunidad</label>
                    <textarea id="area_oportunidad" rows="3" placeholder="Puntos a mejorar detectados..."></textarea>
                </div>
                <div>
                    <label>Comentarios Entrevistador</label>
                    <textarea id="comentarios_entrevista" rows="3" placeholder="Observaciones generales..."></textarea>
                </div>
            </div>
        </div>

        <button type="submit" class="btn-save w-full" id="btnGuardar">
            <i class="ph-bold ph-floppy-disk"></i> GUARDAR INFORMACIÓN
        </button>

    </form>
</div>

<script>
    (function() {
        let selectedCandidateId = null; 
        let globalCandidates = [];

        // 1. CONFIGURACIÓN INICIAL DE ESTADOS (HOMOLOGADA)
        const estados = [
            {n:"AGUASCALIENTES",a:"AGU"}, {n:"BAJA CALIFORNIA",a:"BC"}, {n:"BAJA CALIFORNIA SUR",a:"BCS"},
            {n:"CAMPECHE",a:"CAMP"}, {n:"COAHUILA",a:"COAH"}, {n:"COLIMA",a:"COL"}, {n:"CHIAPAS",a:"CHIS"},
            {n:"CHIHUAHUA",a:"CHIH"}, {n:"CIUDAD DE MEXICO",a:"CDMX"}, {n:"DISTRITO FEDERAL",a:"CDMX"},
            {n:"DURANGO",a:"DGO"}, {n:"GUANAJUATO",a:"GTO"}, {n:"GUERRERO",a:"GRO"}, {n:"HIDALGO",a:"HGO"},
            {n:"JALISCO",a:"JAL"}, {n:"MEXICO",a:"MEX"}, {n:"MICHOACAN",a:"MICH"}, {n:"MORELOS",a:"MOR"},
            {n:"NAYARIT",a:"NAY"}, {n:"NUEVO LEON",a:"NL"}, {n:"OAXACA",a:"OAX"}, {n:"PUEBLA",a:"PUE"},
            {n:"QUERETARO",a:"QRO"}, {n:"QUINTANA ROO",a:"QROO"}, {n:"SAN LUIS POTOSI",a:"SLP"},
            {n:"SINALOA",a:"SIN"}, {n:"SONORA",a:"SON"}, {n:"TABASCO",a:"TAB"}, {n:"TAMAULIPAS",a:"TAM"},
            {n:"TLAXCALA",a:"TLAX"}, {n:"VERACRUZ",a:"VER"}, {n:"YUCATAN",a:"YUC"}, {n:"ZACATECAS",a:"ZAC"}
        ];

        const pSel = document.getElementById('plaza');
        estados.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.a; // Guarda código (ej. NL)
            opt.innerText = `${e.a} - ${e.n}`;
            pSel.appendChild(opt);
        });

        // 2. CARGAR LISTA
        window.cargarListaCandidatos = async () => {
            const select = document.getElementById('candidateSelect');
            select.innerHTML = '<option value="new">-- REGISTRAR NUEVO CANDIDATO (Formulario en Blanco) --</option><option disabled>Cargando datos...</option>';
            
            try {
                const { data, error } = await window.supabase
                    .from('candidates')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if(error) throw error;
                globalCandidates = data || [];
                
                select.innerHTML = '<option value="new">-- REGISTRAR NUEVO CANDIDATO (Formulario en Blanco) --</option>';
                
                if (globalCandidates.length > 0) {
                    const group = document.createElement('optgroup');
                    group.label = "Candidatos Recientes";
                    globalCandidates.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.innerText = `${c.full_name} - ${c.curp || 'S/C'} [${c.status || 'N/A'}]`;
                        group.appendChild(opt);
                    });
                    select.appendChild(group);
                }
            } catch (err) {
                console.error("Error cargando lista:", err);
                select.innerHTML += '<option disabled>Error al cargar lista</option>';
            }
        };

        cargarListaCandidatos();

        // 3. SELECCIÓN DE CANDIDATO
        window.seleccionarCandidato = (val) => {
            if (val === 'new') {
                limpiarFormulario();
            } else {
                const candidato = globalCandidates.find(c => c.id === val);
                if(candidato) cargarDatosCandidato(candidato);
            }
        };

        window.cargarDatosCandidato = (c) => {
            selectedCandidateId = c.id;
            
            const badge = document.getElementById('modeBadge');
            badge.className = 'mode-badge mode-edit';
            badge.innerText = 'EDITANDO: ' + c.full_name.split(' ')[0];
            
            const setVal = (id, val) => { 
                const el = document.getElementById(id); 
                if(el) el.value = (val !== null && val !== undefined) ? val : ''; 
            };

            setVal('full_name', c.full_name);
            setVal('curp', c.curp);
            if(c.curp) procesarCurp(c.curp);
            
            setVal('phone', c.phone);
            setVal('email', c.email);
            setVal('marital_status', c.marital_status);
            setVal('education', c.education); 
            
            setVal('edad_emocional', c.edad_emocional);
            setVal('tiene_hijos', c.tiene_hijos ? 'true' : 'false');
            toggleHijos();
            setVal('cantidad_hijos', c.cantidad_hijos);
            
            setVal('credito_infonavit', c.credito_infonavit ? 'true' : 'false');
            checkInfonavit();
            
            setVal('perfil', c.perfil || 'PROVISIONAL');
            setVal('clave_asesor', c.clave_asesor);
            setVal('veritas_gerencia', c.veritas_gerencia);
            
            // Lógica Plaza / State
            if(c.plaza) {
                setVal('plaza', c.plaza);
            } else if(c.state) {
                // Como ambos guardan código, el mapeo es directo si viene del form nuevo.
                // Si viene de un registro antiguo con nombre completo, intentamos buscar.
                const stateVal = c.state.toUpperCase();
                // Verificamos si es un código válido
                const matchCode = estados.find(e => e.a === stateVal);
                if (matchCode) {
                    setVal('plaza', matchCode.a);
                } else {
                    // Si no es código, buscamos por nombre
                    const matchName = estados.find(e => e.n === stateVal);
                    if(matchName) setVal('plaza', matchName.a);
                }
            }

            setVal('fecha_examen', c.fecha_examen);
            setVal('medio_reclutamiento', c.medio_reclutamiento);
            setVal('perfil_familiar', c.perfil_familiar);
            setVal('sueno_realizar', c.sueno_realizar);
            setVal('area_oportunidad', c.area_oportunidad);
            setVal('comentarios_entrevista', c.comentarios_entrevista);
        };

        window.limpiarFormulario = () => {
            selectedCandidateId = null;
            document.getElementById('formEntrevista').reset();
            const badge = document.getElementById('modeBadge');
            badge.className = 'mode-badge mode-new';
            badge.innerText = 'NUEVO REGISTRO';
            document.getElementById('curp-feedback').innerText = '';
            document.getElementById('candidateSelect').value = 'new';
        };

        // 4. FUNCIONES AUXILIARES
        window.toggleHijos = () => {
            const val = document.getElementById('tiene_hijos').value === 'true';
            const input = document.getElementById('cantidad_hijos');
            input.readOnly = !val;
            if(!val) input.value = 0;
        };

        window.checkInfonavit = () => {
            const val = document.getElementById('credito_infonavit').value === 'true';
            document.getElementById('perfil').value = val ? 'DEFINITIVA' : 'PROVISIONAL';
        };

        window.procesarCurp = (val) => {
            val = val.toUpperCase();
            document.getElementById('curp').value = val;
            const msg = document.getElementById('curp-feedback');
            
            if(val.length === 18) {
                const re = /^[A-Z]{4}(\d{2})(\d{2})(\d{2})[HM][A-Z]{5}([A-Z0-9])(\d)$/;
                const match = val.match(re);
                if(match) {
                    const yy = match[1], mm = match[2], dd = match[3];
                    const fullYear = (parseInt(yy) < 50 ? '20' : '19') + yy;
                    const isoDate = `${fullYear}-${mm}-${dd}`;
                    
                    document.getElementById('birth_date').value = isoDate;
                    
                    const birth = new Date(isoDate);
                    const now = new Date();
                    let edad = now.getFullYear() - birth.getFullYear();
                    const m = now.getMonth() - birth.getMonth();
                    if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) { edad--; }
                    
                    document.getElementById('age').value = edad;
                    msg.innerText = "✅ CURP válida. Fecha calculada."; msg.style.color = "#166534";
                } else {
                    msg.innerText = "⚠️ Formato de CURP inválido"; msg.style.color = "var(--inb-red)";
                }
            } else {
                msg.innerText = "";
            }
        };

        // 5. GUARDADO
        window.guardarDatos = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnGuardar');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph-duotone ph-spinner-gap animate-spin"></i> Guardando...'; 
            btn.disabled = true;

            try {
                const getVal = (id) => { const el = document.getElementById(id); return el.value ? el.value.toUpperCase() : null; };
                const getRaw = (id) => document.getElementById(id).value || null;

                const payload = {
                    full_name: getVal('full_name'),
                    curp: getVal('curp'),
                    phone: getRaw('phone'),
                    email: getRaw('email'),
                    marital_status: getVal('marital_status'),
                    birth_date: getRaw('birth_date'),
                    age: parseInt(getRaw('age')) || 0,
                    edad_emocional: parseInt(getRaw('edad_emocional')) || 0,
                    tiene_hijos: document.getElementById('tiene_hijos').value === 'true',
                    cantidad_hijos: parseInt(getRaw('cantidad_hijos')) || 0,
                    credito_infonavit: document.getElementById('credito_infonavit').value === 'true',
                    perfil: getVal('perfil'),
                    clave_asesor: getVal('clave_asesor'),
                    plaza: getVal('plaza'),
                    veritas_gerencia: getVal('veritas_gerencia'),
                    education: getVal('education'), 
                    fecha_examen: getRaw('fecha_examen'),
                    medio_reclutamiento: getVal('medio_reclutamiento'),
                    perfil_familiar: getVal('perfil_familiar'),
                    sueno_realizar: getVal('sueno_realizar'),
                    area_oportunidad: getVal('area_oportunidad'),
                    comentarios_entrevista: getVal('comentarios_entrevista'),
                    status: 'CONTRATADO'
                };

                if(!selectedCandidateId) {
                    payload.state = 'DESCONOCIDO'; 
                    payload.city = 'DESCONOCIDO';
                    payload.availability = 'INMEDIATA';
                    payload.accept_commission = 'SI';
                    payload.prev_exp = 'NO REGISTRADO';
                    payload.date = new Date().toISOString().split('T')[0];
                }

                let error;
                if(selectedCandidateId) {
                    const res = await window.supabase.from('candidates').update(payload).eq('id', selectedCandidateId);
                    error = res.error;
                } else {
                    const res = await window.supabase.from('candidates').insert([payload]);
                    error = res.error;
                }

                if(error) throw error;

                alert("✅ Información guardada exitosamente.");
                cargarListaCandidatos(); 
                limpiarFormulario();

            } catch (err) {
                console.error(err);
                alert("❌ Error al guardar: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

    })();
</script>