<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GALHER | Portal Dinámico</title>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --bg-dark: #e2e2e2; 
            --bg-panel: #003a98; 
            --primary: #3b82f6;
            --text-main: #f1f5f9; 
            --text-muted: #94a3b8; 
            --border: #010b17;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; }
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; }

        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .w-full { width: 100%; }

        /* VISTA LOGIN */
        #view-login { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 50; background: var(--bg-dark); }
        .login-box { 
            width: 400px; padding: 40px; background: var(--bg-panel); border-radius: 16px; 
            border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
        }

        /* VISTA APP */
        #view-app { display: flex; height: 100%; }
        
        .sidebar { width: 260px; background: var(--bg-panel); padding: 25px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .logo-area { font-size: 1.2rem; font-weight: 700; color: white; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        
        /* Contenedor donde se inyectarán los botones dinámicos */
        #dynamic-menu { flex: 1; overflow-y: auto; }

        .nav-btn { 
            padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; color: var(--text-muted); 
            display: flex; align-items: center; gap: 12px; transition: 0.2s; 
        }
        .nav-btn:hover, .nav-btn.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); font-weight: 600; }

        /* Icono pequeño para indicar enlace externo */
        .icon-external { margin-left: auto; font-size: 0.8rem; opacity: 0.5; }

        .main-content { flex: 1; padding: 40px; overflow-y: auto; position: relative; }
        
        /* Inputs Generales */
        input, button { width: 100%; padding: 12px; border-radius: 8px; margin-top: 5px; margin-bottom: 15px; }
        input { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; }
        
        .btn-primary { background: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; }
        .btn-guest { background: transparent; border: 1px dashed var(--border); color: var(--text-muted); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: none; font-weight: 600; cursor: pointer; }

        /* Loader simple */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="view-login" class="flex-center">
        <div class="login-box">
            <h2 style="text-align:center; margin-bottom:20px;">Portal Corporativo</h2>
            <form onsubmit="loginUsuario(event)">
                <input type="email" id="log-email" placeholder="usuario@galher.com">
                <input type="password" id="log-pass" placeholder="••••••">
                <button type="submit" class="btn-primary" id="btn-login">Iniciar Sesión</button>
                <div style="text-align: center; margin: 10px 0; font-size: 0.8rem; color: var(--border);">o</div>
                <button type="button" class="btn-guest" onclick="entrarComoInvitado()">Entrar como Invitado</button>
            </form>
            <p id="msg-login" style="text-align:center; color: var(--danger); margin-top:10px;"></p>
        </div>
    </div>

    <div id="view-app" class="hidden">
        <aside class="sidebar">
            <div class="logo-area"><i class="ph-fill ph-circles-four" style="color: var(--primary);"></i> GALHER APP</div>
            
            <div id="dynamic-menu">
                </div>

            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border);">
                <div style="margin-bottom: 15px; font-size: 0.9rem;">
                    <strong id="user-display">Usuario</strong>
                    <div style="font-size: 0.75rem; color: var(--text-muted);" id="role-display">Rol</div>
                </div>
                <button onclick="logout()" class="btn-danger w-full">Cerrar Sesión</button>
            </div>
        </aside>

        <main class="main-content" id="main-container">
            <div style="text-align:center; padding-top: 50px; color: var(--text-muted);">
                Cargando contenido...
            </div>
        </main>
    </div>

    <script>
        // 1. CONEXIÓN A SUPABASE
        const SUPABASE_URL = 'https://pavpbtfucesbjapaycsk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhdnBidGZ1Y2VzYmphcGF5Y3NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyODg1MjksImV4cCI6MjA3OTg2NDUyOX0.Z16gzv5y9CDPzhQZKKTVr8UL49bW8y88LZ8Pbq_9ZhQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Hacemos supabase global
        window.supabase = supabase; 

        // 2. INICIO
        document.addEventListener('DOMContentLoaded', () => {
            const session = localStorage.getItem('galher_session_v2');
            if(session) initApp(JSON.parse(session));
        });

        // 3. LÓGICA LOGIN
        async function loginUsuario(e) {
            e.preventDefault();
            const email = document.getElementById('log-email').value;
            const pass = document.getElementById('log-pass').value;
            const btn = document.getElementById('btn-login');

            btn.textContent = "..."; btn.disabled = true;

            try {
                const { data, error } = await supabase.from('equipo').select('*').eq('email', email).eq('password', pass).single();
                if(error || !data) throw new Error("Credenciales inválidas");

                const user = { nombre: data.nombre, rol: data.rol };
                localStorage.setItem('galher_session_v2', JSON.stringify(user));
                initApp(user);

            } catch (err) {
                document.getElementById('msg-login').textContent = err.message;
                btn.textContent = "Iniciar Sesión"; btn.disabled = false;
            }
        }

        function entrarComoInvitado() {
            const user = { nombre: 'Visitante', rol: 'INVITADO' };
            localStorage.setItem('galher_session_v2', JSON.stringify(user));
            initApp(user);
        }

        // 4. INICIALIZAR APP (MODIFICADA PARA ENLACES EXTERNOS)
        async function initApp(user) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('user-display').textContent = user.nombre;
            document.getElementById('role-display').textContent = user.rol;

            const menuContainer = document.getElementById('dynamic-menu');
            menuContainer.innerHTML = '<div class="loader"></div>';

            // Consultamos la tabla 'menus' ordenada
            const { data: menuItems } = await supabase.from('menus').select('*').order('orden', { ascending: true });

            menuContainer.innerHTML = ''; // Limpiar loader

            if(menuItems) {
                let firstPage = null;

                // A. Renderizar Menús
                menuItems.forEach(item => {
                    // VERIFICAR PERMISOS
                    if(item.roles_permitidos.includes(user.rol)) {
                        
                        const btn = document.createElement('div');
                        btn.className = 'nav-btn';
                        
                        // Añadimos un pequeño icono de flecha si es externo para dar feedback visual
                        const externalIcon = item.es_externo ? '<i class="ph-bold ph-arrow-square-out icon-external"></i>' : '';
                        btn.innerHTML = `<i class="${item.icono}"></i> ${item.titulo} ${externalIcon}`;
                        
                        // --- LÓGICA DE CLIC ACTUALIZADA ---
                        btn.onclick = () => {
                            if (item.es_externo) {
                                // 1. Si es externo: abrir en nueva pestaña y NO marcar como activo
                                window.open(item.archivo_html, '_blank');
                            } else {
                                // 2. Si es interno: cargar en el div principal y marcar activo
                                cargarPaginaExterna(item.archivo_html);
                                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                            }
                        };
                        // ----------------------------------

                        menuContainer.appendChild(btn);

                        // Guardar la primera página INTERNA válida para cargarla al inicio
                        // Ignoramos las externas para la carga inicial automática
                        if(!firstPage && !item.es_externo) firstPage = item.archivo_html;
                    }
                });

                // B. ZONA ADMINISTRADOR
                if (user.rol === 'ADMINISTRADOR') {
                    const divider = document.createElement('div');
                    divider.style.borderTop = '1px solid var(--border)';
                    divider.style.margin = '10px 0';
                    menuContainer.appendChild(divider);

                    const btnAdmin = document.createElement('div');
                    btnAdmin.className = 'nav-btn';
                    btnAdmin.style.color = '#fbbf24'; 
                    btnAdmin.innerHTML = `<i class="ph-bold ph-gear"></i> Gestión Menús`;
                    btnAdmin.onclick = () => {
                        cargarPaginaExterna('gestion_menus.html');
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                        btnAdmin.classList.add('active');
                    };
                    menuContainer.appendChild(btnAdmin);
                }

                // C. Cargar página inicial
                if(firstPage) cargarPaginaExterna(firstPage);
                else if (user.rol === 'ADMINISTRADOR') cargarPaginaExterna('gestion_menus.html');
                else document.getElementById('main-container').innerHTML = '<p style="text-align:center; color:#94a3b8; padding-top:50px;">Bienvenido al Portal.</p>';
            }
        }

        // 5. CARGADOR DE HTML
        async function cargarPaginaExterna(archivo) {
            const container = document.getElementById('main-container');
            container.innerHTML = '<div style="text-align:center; padding-top:50px; color:#94a3b8;">Cargando...</div>';

            try {
                const response = await fetch(archivo);
                
                if(!response.ok) throw new Error("No se encontró el archivo: " + archivo);
                
                const htmlContent = await response.text();
                container.innerHTML = htmlContent;

                const scripts = container.querySelectorAll("script");
                scripts.forEach(oldScript => {
                    const newScript = document.createElement("script");
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

            } catch (err) {
                container.innerHTML = `
                    <div style="text-align:center; color: #ef4444; padding-top: 50px;">
                        <h3>Error al cargar sección</h3>
                        <p>${err.message}</p>
                        <small>Verifica que el archivo exista.</small>
                    </div>
                `;
            }
        }

        function logout() {
            localStorage.removeItem('galher_session_v2');
            window.location.reload();
        }
    </script>
</body>
</html>