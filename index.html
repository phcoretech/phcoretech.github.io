<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GALHER | Portal Corporativo</title>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. PALETA DE COLORES INBURSA & VARIABLES --- */
        :root {
            --inb-navy: #003366;       /* Azul Inbursa */
            --inb-red: #E30613;        /* Rojo Inbursa */
            --inb-blue-soft: #005DAA;  /* Azul Profesional */
            
            /* Fondos */
            --inb-bg: #F4F7F9;         /* Gris Platino (Login) */
            --main-bg-dark: #0f172a;   /* Fondo oscuro contenido */
            
            /* Textos y neutros */
            --text-main: #1A1A1A;      
            --text-sec: #666666;       
            --white: #FFFFFF;          
            --border: #E0E0E0;         
        }

        /* --- ESTILOS BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; }
        
        body { 
            background-color: var(--inb-bg);
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
        }

        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .w-full { width: 100%; }

        /* --- VISTA LOGIN --- */
        #view-login { 
            position: absolute; top:0; left:0; width:100%; height:100%; z-index: 100; 
            background: var(--inb-bg); 
        }
        
        .login-box { 
            width: 400px; padding: 50px 40px; 
            background: var(--white); 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            box-shadow: 0 4px 20px rgba(0, 51, 102, 0.08);
            position: relative; 
            z-index: 101;
        }

        .login-box h2 {
            color: var(--inb-navy);
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            letter-spacing: -0.5px;
        }

        /* --- VISTA APP --- */
        #view-app { display: flex; height: 100%; position: relative; z-index: 1; }
        
        /* SIDEBAR */
        .sidebar { 
            width: 280px; 
            background: var(--inb-navy); 
            padding: 25px; 
            border-right: none; 
            display: flex; 
            flex-direction: column;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), padding 0.3s ease;
            overflow: hidden;
            white-space: nowrap;
            color: var(--white);
            box-shadow: 4px 0 15px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .logo-area { 
            font-size: 1.1rem; 
            font-weight: 600; 
            color: var(--white); 
            margin-bottom: 40px; 
            display: flex;
            align-items: center; 
            gap: 12px; 
            justify-content: space-between;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        /* --- SCROLLBAR PERSONALIZADO PARA EL MENÚ (NUEVO) --- */
        #dynamic-menu { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            
            /* Firefox */
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
            padding-right: 5px; /* Espacio para que no se pegue el texto */
        }

        /* Webkit (Chrome, Edge, Safari) */
        #dynamic-menu::-webkit-scrollbar {
            width: 2px; /* Barra muy delgada */
        }
        #dynamic-menu::-webkit-scrollbar-track {
            background: transparent; /* Fondo invisible */
        }
        #dynamic-menu::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2); /* Color sutil */
            border-radius: 20px; /* Bordes redondos */
        }
        #dynamic-menu::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.5); /* Más visible al pasar el mouse */
        }
        /* --------------------------------------------------- */

        .nav-btn { 
            padding: 14px 16px; 
            margin-bottom: 6px; 
            border-radius: 6px; 
            cursor: pointer; 
            color: rgba(255,255,255, 0.7); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 400;
        }

        .nav-btn:hover { background: rgba(255, 255, 255, 0.1); color: var(--white); }
        .nav-btn.active { background: var(--inb-blue-soft); color: var(--white); font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .icon-external { margin-left: auto; font-size: 0.8rem; opacity: 0.6; }

        /* --- MAIN CONTENT --- */
        .main-content { 
            flex: 1; 
            padding: 40px; 
            overflow-y: auto; 
            position: relative; 
            background-color: var(--main-bg-dark);
        }
        
        #user-info-container {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        #user-display { color: var(--white); display: block; }
        #role-display { color: rgba(255,255,255,0.6); font-size: 0.75rem; margin-top: 2px;}

        /* --- INPUTS & BUTTONS --- */
        input { 
            width: 100%; padding: 14px; border-radius: 6px; margin-top: 5px; margin-bottom: 20px; 
            background: #F8FAFC; border: 1px solid var(--border); color: var(--text-main);
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--inb-blue-soft); background: var(--white); }

        button { 
            width: 100%; padding: 14px; border-radius: 6px; margin-bottom: 15px; cursor: pointer; 
            font-size: 0.95rem; transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.98); }

        .btn-primary { background: var(--inb-navy); color: var(--white); border: none; font-weight: 600; box-shadow: 0 4px 6px rgba(0, 51, 102, 0.2); }
        .btn-primary:hover { background: #002244; }

        .btn-guest { background: transparent; border: 1px solid var(--border); color: var(--text-sec); }
        .btn-guest:hover { border-color: var(--inb-navy); color: var(--inb-navy); background: var(--white); }

        .btn-danger { 
            background: rgba(227, 6, 19, 0.15); color: #FFCDD2; border: 1px solid rgba(227, 6, 19, 0.3);
            font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-danger:hover { background: var(--inb-red); color: white; border-color: var(--inb-red); }

        /* Loader */
        .loader { border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid var(--inb-blue-soft); border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- TOOLTIP FLOTANTE --- */
        .custom-tooltip {
            position: fixed;
            background-color: #1e293b; 
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            z-index: 9999; 
            pointer-events: none; 
            white-space: nowrap;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
            font-weight: 500;
            opacity: 0;
            animation: fadeInTooltip 0.2s forwards;
        }
        @keyframes fadeInTooltip { to { opacity: 1; } }

        /* ================================================= */
        /* === SIDEBAR COLAPSADO (CONFIG) === */
        /* ================================================= */
        .sidebar.collapsed { width: 80px; padding: 25px 10px; }
        
        .sidebar.collapsed .logo-text,
        .sidebar.collapsed #user-info-container,
        .sidebar.collapsed .btn-text-logout,
        .sidebar.collapsed .nav-text,     
        .sidebar.collapsed .icon-external 
        { display: none !important; }

        .sidebar.collapsed .nav-btn { justify-content: center; padding: 14px 0; }
        .sidebar.collapsed .nav-btn i { font-size: 1.6rem !important; margin: 0 !important; }

        .sidebar.collapsed .logo-area { flex-direction: column-reverse; gap: 15px; justify-content: center; margin-bottom: 20px; border: none; }
        .sidebar.collapsed .logo-area i:first-child { font-size: 1.8rem !important; }
        
        .sidebar.collapsed .btn-danger { justify-content: center; padding: 14px 0; }
        .sidebar.collapsed .btn-danger i { font-size: 1.6rem !important; margin: 0; }
        
        .sidebar.collapsed .toggle-btn { margin: 0 auto; transform: rotate(180deg); }
        /* ================================================= */

        .toggle-btn { background: transparent; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 5px; width: auto; margin: 0; }
        .toggle-btn:hover { color: var(--white); }
        
    </style>
</head>
<body>

    <div id="view-login" class="flex-center">
        <div class="login-box">
            <h2>Acceso Corporativo</h2>
            <form onsubmit="loginUsuario(event)" action="javascript:void(0);">
                <label style="font-size:0.85rem; color:var(--text-sec); font-weight:600; margin-bottom:4px; display:block;">Correo Electrónico</label>
                <input type="email" id="log-email" placeholder="usuario@galher.com" autocomplete="email">
                 
                <label style="font-size:0.85rem; color:var(--text-sec); font-weight:600; margin-bottom:4px; display:block;">Contraseña</label>
                <input type="password" id="log-pass" placeholder="••••••" autocomplete="current-password">
              
                <button type="submit" class="btn-primary" id="btn-login">Iniciar Sesión</button>
                <div style="text-align: center; margin: 15px 0; font-size: 0.8rem; color: var(--text-sec);">o</div>
                <button type="button" class="btn-guest" onclick="entrarComoInvitado()">Continuar como Invitado</button>
            </form>
            <p id="msg-login" style="text-align:center; color: var(--inb-red); margin-top:15px; font-size: 0.9rem; font-weight: 500;"></p>
        </div>
    </div>

    <div id="view-app" class="hidden">
        
        <aside class="sidebar collapsed" id="main-sidebar">
            <div class="logo-area">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i class="ph-fill ph-bank" style="color: var(--white); font-size: 1.4rem;"></i> 
                    <span class="logo-text" style="letter-spacing: 0.5px;">GALHER CORPORATIVO</COde></span>
                </div>
                <button class="toggle-btn" onclick="toggleSidebar()">
                    <i class="ph-bold ph-caret-circle-right" style="font-size: 1.4rem;"></i>
                </button>
            </div>
            
            <div id="dynamic-menu"></div>

            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div id="user-info-container">
                    <strong id="user-display">Usuario</strong>
                    <div id="role-display">Rol</div>
                </div>
                <button onclick="logout()" class="btn-danger w-full">
                    <i class="ph-bold ph-sign-out"></i> <span class="btn-text-logout">Cerrar Sesión</span>
                </button>
            </div>
        </aside>

        <main class="main-content" id="main-container">
            <div style="text-align:center; padding-top: 80px; color: rgba(255,255,255,0.7);">
                <i class="ph-duotone ph-spinner-gap" style="font-size: 2rem; animation: spin 1s infinite linear; color: var(--inb-blue-soft);"></i>
                <p style="margin-top: 10px; color: rgba(255,255,255,0.5);">Cargando contenido...</p>
            </div>
        </main>
    </div>

    <script>
        // 1. CONEXIÓN A SUPABASE
        const SUPABASE_URL = 'https://pavpbtfucesbjapaycsk.supabase.co';
        const KEY_PART_1 = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhdnBidGZ1Y2VzYmphcGF5Y3NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyODg1MjksImV4cCI6MjA3OTg2NDUyOX0.';
        const KEY_PART_2 = 'Z16gzv5y9CDPzhQZKKTVr8UL49bW8y88LZ8Pbq_9ZhQ';
        const SUPABASE_KEY = KEY_PART_1 + KEY_PART_2;

        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            window.supabase = supabase; 
        } catch (e) {
            console.error("Error init Supabase", e);
        }

        // 2. INICIO
        document.addEventListener('DOMContentLoaded', () => {
      
            const session = localStorage.getItem('galher_session_v2');
            if(session) {
                try { initApp(JSON.parse(session)); } catch(e) { logout(); }
            }
        });

        // --- FUNCIÓN TOGGLE SIDEBAR ---
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const icon = document.querySelector('.toggle-btn i');
            sidebar.classList.toggle('collapsed');
            
            hideTooltip();

            if(sidebar.classList.contains('collapsed')) {
                icon.classList.replace('ph-caret-circle-left', 'ph-caret-circle-right');
            } else {
                icon.classList.replace('ph-caret-circle-right', 'ph-caret-circle-left');
            }
        }

        // 3. LÓGICA LOGIN
        async function loginUsuario(e) {
            e.preventDefault();
            if(!supabase) return;

            const email = document.getElementById('log-email').value;
            const pass = document.getElementById('log-pass').value;
            const btn = document.getElementById('btn-login');

            btn.textContent = "Verificando..."; btn.disabled = true;
            try {
                const { data, error } = await supabase.from('equipo').select('*').eq('email', email).eq('password', pass).single();
                if(error || !data) throw new Error("Credenciales inválidas");

                const user = { nombre: data.nombre, rol: data.rol };
                localStorage.setItem('galher_session_v2', JSON.stringify(user));
                initApp(user);
            } catch (err) {
                document.getElementById('msg-login').textContent = err.message || "Error de acceso";
                btn.textContent = "Iniciar Sesión"; btn.disabled = false;
            }
        }

        function entrarComoInvitado() {
            const user = { nombre: 'Visitante', rol: 'INVITADO' };
            localStorage.setItem('galher_session_v2', JSON.stringify(user));
            initApp(user);
        }

        // 4. INICIALIZAR APP
        async function initApp(user) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('user-display').textContent = user.nombre;
            document.getElementById('role-display').textContent = user.rol;

            const menuContainer = document.getElementById('dynamic-menu');
            menuContainer.innerHTML = '<div class="loader"></div>';
            
            if(!supabase) return;
            const { data: menuItems } = await supabase.from('menus').select('*').order('orden', { ascending: true });
            menuContainer.innerHTML = '';
            if(menuItems) {
                let firstPage = null;
                menuItems.forEach(item => {
                    if(item.roles_permitidos.includes(user.rol)) {
                        const btn = document.createElement('div');
                        btn.className = 'nav-btn';
                        
                        const externalIcon = item.es_externo ? '<i class="ph-bold ph-arrow-square-out icon-external"></i>' : '';
                        
                        btn.innerHTML = `<i class="${item.icono}" style="font-size:1.1rem;"></i> <span class="nav-text">${item.titulo}</span> ${externalIcon}`;
                        
                        // TOOLTIP EVENTS
                        btn.onmouseenter = (e) => showTooltip(e, item.titulo);
                        btn.onmouseleave = hideTooltip;

                        btn.onclick = () => {
                            if (item.es_externo) {
                                window.open(item.archivo_html, '_blank');
                            } else {
                                cargarPaginaExterna(item.archivo_html);
                                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                                
                                // AUTO COLAPSAR (Si estuviera abierta, que no es el caso por defecto ahora)
                                const sidebar = document.getElementById('main-sidebar');
                                if (!sidebar.classList.contains('collapsed')) toggleSidebar();
                            }
                        };
                        menuContainer.appendChild(btn);
                        if(!firstPage && !item.es_externo) firstPage = item.archivo_html;
                    }
                });
                
                if (user.rol === 'ADMINISTRADOR') {
                    const divider = document.createElement('div');
                    divider.style.borderTop = '1px solid rgba(255,255,255,0.1)';
                    divider.style.margin = '10px 0';
                    menuContainer.appendChild(divider);

                    const btnAdmin = document.createElement('div');
                    btnAdmin.className = 'nav-btn';
                    btnAdmin.style.color = '#FCD34D';
                    
                    btnAdmin.innerHTML = `<i class="ph-bold ph-gear"></i> <span class="nav-text">Gestión Menús</span>`;
                    
                    btnAdmin.onmouseenter = (e) => showTooltip(e, "Gestión Menús");
                    btnAdmin.onmouseleave = hideTooltip;

                    btnAdmin.onclick = () => {
                        cargarPaginaExterna('gestion_menus.html');
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                        btnAdmin.classList.add('active');
                        const sidebar = document.getElementById('main-sidebar');
                        if (!sidebar.classList.contains('collapsed')) toggleSidebar();
                    };
                    menuContainer.appendChild(btnAdmin);
                }

                if(firstPage) cargarPaginaExterna(firstPage);
                else if (user.rol === 'ADMINISTRADOR') cargarPaginaExterna('gestion_menus.html');
                else document.getElementById('main-container').innerHTML = '<p style="text-align:center; color:#94a3b8; padding-top:50px;">Bienvenido.</p>';
            }
        }

        // 5. CARGADOR DE HTML
        async function cargarPaginaExterna(archivo) {
            const container = document.getElementById('main-container');
            container.innerHTML = '<div style="text-align:center; padding-top:80px; color:rgba(255,255,255,0.7);"><i class="ph-duotone ph-spinner-gap" style="font-size: 2rem; animation: spin 1s infinite linear; color: #005DAA;"></i><br>Cargando...</div>';
            try {
                const response = await fetch(archivo);
                if(!response.ok) throw new Error("No se encontró el módulo: " + archivo);
                
                const htmlContent = await response.text();
                container.innerHTML = htmlContent;
                const scripts = container.querySelectorAll("script");
                scripts.forEach(oldScript => {
                    const newScript = document.createElement("script");
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                  });
            } catch (err) {
                container.innerHTML = `
                    <div style="text-align:center; color: #E30613; padding-top: 50px;">
                        <h3>Error de Carga</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        function logout() {
            localStorage.removeItem('galher_session_v2');
            window.location.reload();
        }

        // --- FUNCIONES TOOLTIP ---
        function showTooltip(e, text) {
            const sidebar = document.getElementById('main-sidebar');
            // Solo mostramos si está colapsado
            if(!sidebar.classList.contains('collapsed')) return;

            const tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            tooltip.innerText = text;
            document.body.appendChild(tooltip);

            const rect = e.currentTarget.getBoundingClientRect();
            // Centrado vertical
            const top = rect.top + (rect.height / 2) - (tooltip.offsetHeight / 2) - 8; 
            
            tooltip.style.top = `${rect.top + 10}px`; 
            tooltip.style.left = `${rect.right + 15}px`; 
        }

        function hideTooltip() {
            const t = document.querySelector('.custom-tooltip');
            if(t) t.remove();
        }

    </script>
</body>
</html>